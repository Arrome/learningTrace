# 数据持久化

RDB
-----
根据指定规则“定时”将内存中数据存储在硬盘上（符合一定条件时redis自动将内存中所有数据生成一份副本并存储在硬盘上，即"快照"）<br>
默认将快照文件存储在redis当前进程的工作目录中的dump.rdb文件中，自定义配置dir和dbfilename两参数分别指定快照文件存储路径和文件名<br>
对数据快照的几种情况：
* 根据配置规则进行自动快照
  快照条件可以在配置文件中自定义，可多行条件`save M N` 表示：每当时间M（单位：秒）内被更改的键的个数大于N时进行快照
* 用户执行 SAVE 或 BGSAVE 命令
  手动快照，执行命令：
  1. `save` redis同步进行快照操作，执行过程中会阻塞所有来自客户端请求(数据较多时，导致redis长时间不响应，**避免生产中使用**)
  2. `BGSAVE` redis后台异步进行快照操作，同时继续响应客户端请求。（确认是否完成，`lastsave`命令返回最近一次成功Unix时间戳）**推荐使用**
* 执行 FLUSHALL 命令
  **清除数据库所有数据**<br>
  **注意**:
  不论清空数据库过程是否触发了自动快照条件，只要自动快照条件不为空，redis就会执行一次快照操作。<br>
  **如果没有定义自动快照条件时，执行`flushall`则不会进行快照**
* 执行复制（replication）时
  设置为主从模式时，redis在复制初始化时进行自动快照，即使没有定义自动快照条件，没有手动执行快照操作

AOF
-----
当redis**存储非临时数据时**，一般需要**打开AOF持久化来降低进程中止导致的数据丢失**<br>
原理：将redis执行的每条写命令追加到磁盘文件（降低redis性能，但可接受范围，较快磁盘提高性能）<br>
默认未开启AOF（append only file），可通过配置`appendonly yes`参数启用<br>
文件保存位置和RDB相同，默认：appendonly.aof,通过配置`appendfilename appendonly.aof`参数修改<br>
redis会记录无效命令，达到一定条件redis可自动重写AOF文件进行优化，通过配置`auto-aof-rewrite-percentage 100`（当前AOF文件大小超过上一次重写时的AOF文件大小的百分之多少时再次进行重写，若之前无重写过，则以启动时AOF文件大小为依据）和
`auto-aof-rewrite-min-size 64mb`（限制允许重写的最小AOF文件大小，AOF文件很小，不太关心冗余）<br>
`bgrewriteaof`命令手动执行AOF重写<br>
由于操作系统的缓存机制，数据并没有真正写入硬盘，而是进入系统的硬盘缓存。默认情况系统每30s执行一次同步操作，真正写入硬盘。期间系统异常退出导致磁盘缓存数据丢失。主动要求系统将缓存内容同步到硬盘，通过配置`appendfsync`参数，默认采用`everysec`每秒钟同步一次，`always`每次执行都同步，最安全但最慢。`no`按系统30s一次

> 通过RDB方式实现持久化，一旦redis异常退出，就会丢失最后一次快照以后更改的所有数据
