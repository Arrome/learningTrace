# 主从复制（replication）

**功能**：主数据库（可进行读写操作）当写操作导致数据变化时会自动将数据同步给从数据库（一般只读，并接受主数据库同步过来的数据）
**主从关系**：一对多
**配置**：
只需要在从数据库配置文件中配置`slaveof 主数据库IP 主数据库port`，主数据库无需任何配置<br>
或者执行`slaveof 主数据库IP 主数据库port`命令修改，当其已经是其他数据库的从数据库，slaveof命令会停止和原来数据库同步转而同新数据库同步。<br>
对从数据库，可使用`slaveof no one`命令是当前数据库停止接收其他数据库同步并转换为主数据库

**获取数据库实例信息**：`INFO replication`命令

复制原理
--------
**复制初始化**：当一个从数据库启动后，会向主数据库发送SYNC命令。同时主数据库接收到SYNC命令后会开始在后台保存快照（RDB持久化，即便关闭了RDB方式的持久化，即删除所有save参数），并将保存快照期间接收到的命令缓存起来。redis会将快照文件和缓存的命令发送给从数据库。从数据库收到后，会载入快照文件并执行收到的缓存的命令。<br>
**复制同步**：主数据库每当收到写命令时就会将命令同步给从数据库

> **每次数据同步都采用复制初始化 缺点**：
>  1. **当主数据库禁用RDB快照，如果执行了复制初始化操作，redis依然会生成RDB快照，下次启动后主数据库会以该快照恢复数据。**
>  2. 磁盘读写速度成为性能瓶颈

**版本优化对比**：<br>
* redis2.6之前，断开重连后，重新复制初始化<br>
* redis2.8 改进，支持有条件的增量数据传输（只需要将断线期间执行的命令传给从数据库）<br>
  1. 主数据库判断从数据库（从数据库会保存主数据库运行ID）传来的运行ID是否和自己运行ID相同
  2. 判断从数据库最后同步成功的命令偏移量是否在积压队列中，若在则执行增量复制，并把积压队列中相应命令发送给从数据库。若不在，主数据库进行一次全量同步<br>

  配置中配置`repl-backlog-size`设置积压队列，默认1MB
   `repl-backlog-ttl`，当所有从数据库与主数据库断开来接后，经过多久可以释放积压队列的内存空间，默认1小时
* redis2.8.18 之后支持了无硬盘复制<br>
  配置中配置`repl-diskless-sync yes`开启，redis主从数据库复制初始化时将不会将快照内容存储到硬盘上，而是直接通过网络发送给从数据库，避免硬盘性能瓶颈

乐观复制（分布式数据最终一致性，防止网络分区造成问题）
-------
容忍在一定时间内主从数据库内容是不同的，但两者数据库最终同步。<br>
主从复制本质是异步的，如果网络连接断开，两者数据就不一致，<br>
通过配置（此特性默认关闭），解决数据库数据不一致问题（分布式中因网络分区导致数据不一致问题）：
  * `min-slaves-to-write 3` 表示只有当3个或3个以上的从数据库连接到主数据库时，主数据才是可写的，否则返回错误
  * `min-slaves-max-lag` 表示允许从数据库最长失去连接的时间。如果从数据库最后与主数据库联系（发送`replconf ack`命令）的时间小于这个值，则认为从数据库还在保持与主数据的连接

读写分离（提高服务器负载能力）
-------
读频率大于写，大量耗资源读请求，单机redis无法应付<br>
主数据库用来只写操作，从数据库负责读操作

从数据库持久化
------------
由于持久化相对耗时，可将持久化交由从数据库来做。<br>
**从数据库启动持久化，主数据库禁用持久化**，当从数据库崩溃重启后主数据库会自动将数据同步过来<br>

* **主数据库崩溃时，手动恢复数据过程**：
  1. 从数据库中使用`slaveof no one`提升为主数据库提供服务
  2. 启动之前主数据，`slaveof` 命令将其设置成新的主数据库的从数据库，将数据同步回来
  > 注意：开启复制且主数据库关闭持久化功能时，一定不要使用工具令主数据库崩溃重启（Supervisor类似进程管理工具），会导致数据库全被清空

* **主数据库崩溃时，自动化哨兵**：<br>
**功能**：<br>
1. 监控主数据库和从数据库是否正常运行 <br>
2. 主数据库故障时自动将从数据库转为主数据库
  **一个主从系统中可以有多个哨兵同时监控整个系统，哨兵间也可相互监控**<br>
