# 核心概念

1.消息（record）
---------
Kafka 通信基本单位，由一个固定长度的消息头和一个可变长度的消息体构成。

2.主题（topic）
---------
Kafka 将一组消息抽象归纳为一个主题。(一个主题就是对消息的分类)生产者将消息发送到特定主题，消费者订阅主题或主题的某些分区进行消费。

3.分区和副本
-----------
每个主题被分成一个或多个分区，每个分区有一个至多个副本(分区的副本分布在集群的不同代理上，以提高可用性)。<br>

每个主题对应的分区数可以在 Kafka 启动时所加载的配置文件中配置，也可以在创建主题时指定，客户端还可以在创建后修改主题分区数。

分区在物理上对应为一个文件夹<br>
**分区命名规则(即文件夹名称)**：“主题名称-分区编号”，分区编号从0开始，编号最大值为分区总数减1<br>
**存储分析**：分区每个副本在逻辑上抽象为一个日志对象，即分区副本和日志对象一一对应

**分区特点优点**：
1. 使 Kafka 在并发处理上变得更加容易。理论上说，分区数越多吞吐量越高（消息被追加到相应分区，顺序写磁盘，效率高，保证了Kafka高吞吐率），这要根据集群实际环境及业务场景而定。
2. Kafka保证消息被顺序消费以及对消息进行负载均衡的基础
3. **每个分区由一系列有序、不可变的消息组成，是一个有序队列.** Kafka 只能保证一个分区内消息有序,并不能保证跨分区消息的有序性。
4. 与传统消息系统不同，Kafaka不会立即删除已被消费的消息，由于磁盘限制也不会一直被存储。

两种删除老数据的策略（配置文件配置）：
  1. 基于消息已存储的时间长度
  2. 基于分区大小

4.Leader 副本和 Follower副本
-----------------------------
因为Kafka 副本存在，需要保证一个分区的多个副本之间数据的一致性。<br>
Kafka 选择该分区的一个副本为 Leader 副本，该分区其他副本为 Follower 副本。只有 Leader 副本负责处理客户端读/写请求，Follower 副本从 Leader副本同步数据。如果 Leader 失效，通过相应的选举算法从其他 Follower副本中选出新的 Leader 副本。

5.偏移量
-----------------
任何发布到分区的消息会被直接追加到日志文件(分区目录以下以“.log”为文件名后缀的数据文件)的尾部，而每条消息在日志文件中的位置都会对应一个按序递增的偏移量。偏移量是一个分区下严格有序的逻辑值，她并不表示消息在磁盘上的物理位置。<br>
Kafka几乎不允许对消息进行随机读写，因此Kafka并没有提供额外索引机制到存储偏移量，也就是说并不会给偏移量再提供索引。消费这可以通过控制消息偏移量来对消息进行消费，为保证消息被顺序消费，消费者已消费的消息对应的偏移量也要保存。

6.日志段
---------------
一个日志被划分为多个日志段，日志段是Kafka日志对象分片的最小单位，与日志对象一样，日志段也是逻辑概念。一个日志段对应磁盘上一个具体日志文件和两个索引文件(.index和.timeindex为文件名后缀，分别表示消息偏移量索引文件和消息时间戳索引文件)。

7.代理
--------------
Kafka 集群有一个或多个 Kafka 实例构成。每个 Kafka 实例称为代理(Broker)，也称为 Kafka 服务器。<br>
每个代理都有唯一标识id，这个id为一个非负整数.在启动代理时配置的 broker.id 对应的值。

8.生产者
-------------
生产者并非每条消息直接通过网络发送到服务器，而是在内存中收集足够数据（多条消息按照分区进行分组），并在一个请求中一次性发送一个消息集，并对消息集进行压缩，减小网络传输的带宽，提高传输效率。<br>
生产者发布消息根据消息是否有键，采用不同的分区策略：
* 没有键，通过轮询方式进行客户端负载均衡
* 有键，根据分区语义确保相同键的消息发送到同一个分区

9.消费者
-------------
每个消费者都属于一个特定消费組，可以为每个消费者指定一个消费組(消费組是Kafka用来实现对一个主题消息进行广播和单播的手段)
以groupId代表消费組名称，通过group.id配置设置。若不指定消费組，消费者默认消费組 test-consumer-group<br>
每个消费者也有一个全局唯一id，通过配置项client.id指定。若客户端不指定消费者id，自动为该消费者生成一个全局id，格式为${groupId}-${hostName}-${timestamp}-${UUID前8位字符}<br>
同一主题的一条消息只能被同一个消费組下某一个消费者消费，但不同消费組的消费者可以同时消费该消息。(实现消息广播只需要指定各消费者均属于不同的消费組，消息单播则只需让各消费者属于同一个消费組)<br>

同一个消费组下多个消费者互相协调消费工作，kafka将所有分区平均分配给所有的消费者实例。kafka消费组管理协议会动态维护消费组的成员列表。<br>

消费模型：拉取模式，消费者自己记录消息消费（偏移量），每个消费者互相独立地顺序读取每个分区的消息。
消费者控制偏移量优点：消费者可以按任意的顺序消费消息。比如消费者可以重置到旧的偏移量，或者跳到最近位置开始消费<br>
拉取模式缺点：消息代理没有数据或者数据量很少，消费者可能需要不断轮询，并等待新数据到来。方案：拉取请求以阻塞式、长轮询方式等待，可以指定收集足够字节数据，客户端拉取请求再返回<br>

10.ISR(In-sync Replica)
----------
Kafka 在 Zookeeper中动态维护了一个ISR,即保存同步的副本列表，该列表中保存的是与Leader副本保持消息同步的所有副本对应的代理节点Id。如果一个Follower副本宕机，Follower副本节点将从ISR列表中移除

11.Zookeeper
Kafka 利用 ZooKeeper 保存相应元数据信息，包括如代理节点信息、Kafka集群信息、旧版消费者信息及其消费偏移量信息、主题信息、分区状态信息、分区副本分配方案信息、动态配置信息等。<br>
Kafka通过监听机制在这些节点注册相应监听器来监听节点元数据的变化。ZooKeeper管理，能很方便对Kafka集群进行水平扩展及数据迁移
